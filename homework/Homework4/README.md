# Домашнее задание

## Подготовка:

Скопировать в проект заготовки:
- `.gitlab-ci.yml`
- `.golangci.yml`
- `.pre-commit-config.yaml`
- `.protolint.yaml`

## Задание:

- Повторить действия из урока
  - Реализовать джобы
    - `build`
    - `unit`
    - `linter`
    - `pre-commit`
    - `http test`
    - `grpc test`

## Критерии приемки задания:
- Есть pipeline с джобами: 
  - В стейдже `build` находятся джобы
    - `build`
    - `unit`
    - `linter`
    - `pre-commit`
  - В стейдже `e2e` находятся джобы
    - `http test`
    - `grpc test`
  - Джобы `ready to prod` и `close release` должны быть с ручным запуском
  - pipeline запускается по пушу в ветку
  - Все джобы в pipeline зеленые
  - Джобы выполняют свою полезную работу
    - `build` - сборка бинарника нашего сервиса
    - `unit` - прогон unit-тестов + сохранение в артефакты репорта в junit формате
    - `linter` - прогон линтера
    - `pre-commit` - прогон pre-commit-хуков
    - `http test` - прогон http-тестов + сохранение в артефакты репорта в junit формате
    - `grpc test` - прогон grpc-тестов + сохранение в артефакты репорта в junit формате

## Задание на :gem: :
### 1. :gem: Запускать джобы, связанные с продом в отдельном pipeline
  Если вы обратите внимание, то заметите, что в pipeline есть джобы связанные с продом
  - `release image` - "создание" образа для прода 
  - `production` - "деплой" образа на прод
  - `production latest` - "смена" дефолтного роута на новую версию сервиса
  - `close release` - "закрытие" релиза

  Эти джобы должны появляться только в том случае, когда нам надо раскатить наш релиз на проде
  
  Необходимо поправить конфигурацию следующим образом:
  - При пуше в ветку запускаются все джобы, кроме указанных выше
  - Вышеуказанные джобы запускаются только в pipeline запущенном через `COMMIT_TAG`
    - Подсказка: необходимо воспользоваться конструкцией `rules`
  ### Критерии приемки задания:
  - Есть pipeline для обычных веток.
    - В нем отсутствуют вышеуказанные джобы
  - Есть pipeline запущенный `COMMIT_TAG`-ом
    - В нем только вышеуказанные джобы
    - Джобы `production latest` и `close release` должны быть с ручным запуском 

  #### Для проставления тега можно использовать команды
  ```shell
  git tag release/0.0.1       
  git push --tags origin 
  ```
### 2. :gem: :gem: Заменить `production latest` на `canary`-джобы
  Задание - продолжение предыдущего

  Вместо смены дефолтного роута для всех пользователей необходимо реализовать джобы для канареечного релиза
  
  Необходимо поправить конфигурацию следующим образом:
  - Добавить новый stage `canary` перед стейджом  `close`
  - Заменить `production latest` на несколько `canary`-джоб
    - canary 0%
    - canary 1%
    - canary 5%
    - canary 10%
    - canary 20%
    - canary 50%
    - canary 100%
  ### Критерии приемки задания:
  - Есть pipeline запущенный `COMMIT_TAG`-ом
    - В этом pipeline вместо `production latest` несколько `canary`-джоб
    - Все `canary`-джобы нахоятся в стедже `canary`
    - Есть шаблон `.canary`, который наследуют все `canary`-джобы
      - В шаблоне должны быть прописаны
        - правила запуска 
        - переменная `CANARY`, через которую передается % для вывода сообщения
    - При запуске `canary`-джоб должно выводиться сообщение
      - echo "Canary 0/10/50/100%"
        - проценты должны соответствовать процентам в названии джобы
